@model MiRoti.Models.Plato
@{
    ViewData["Title"] = "Editar Plato";
}

<div class="container mt-4">
    <h2 class="fw-bold mb-4">Editar Plato</h2>

    <form asp-action="Edit" enctype="multipart/form-data">
        <input type="hidden" id="ingredientesData" name="ingredientesData" />
        <input type="hidden" asp-for="Id" />

        <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input asp-for="Nombre" class="form-control" />
        </div>

        <div class="mb-3">
            <label class="form-label">Descripci√≥n</label>
            <textarea asp-for="Descripcion" class="form-control"></textarea>
        </div>

        <div class="row">
            <div class="col-md-6 mb-3">
                <label class="form-label">Precio Venta</label>
                <input asp-for="PrecioVenta" class="form-control" type="number" step="0.01" />
            </div>
            <div class="col-md-6 mb-3">
                <label class="form-label">Costo Total (Calculado)</label>
                <input asp-for="CostoTotal" class="form-control" type="number" step="0.01" readonly style="background-color: #f8f9fa;" />
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Costo Total (Manual - opcional)</label>
            <input type="number" id="costoTotalManual" name="costoTotalManual" class="form-control" step="0.01" min="0" placeholder="Dejar vac√≠o para mantener/calcular autom√°ticamente" />
            <div class="form-text">Si complet√°s este campo, se usar√° este valor y no se recalcular√° el costo total.</div>
        </div>

        <div class="mb-3">
            <label class="form-label">Ingredientes del Plato</label>
            <div id="ingredientesPlato">
                <div class="row mb-2">
                    <div class="col-5">
                        <select class="form-select ingrediente-select" onchange="calcularSubtotal(this)">
                            <option value="">Seleccione ingrediente</option>
                        </select>
                    </div>
                    <div class="col-3">
                        <input type="number" class="form-control cantidad-input" placeholder="Cantidad" step="0.01" min="0.01" oninput="calcularSubtotal(this)" />
                    </div>
                    <div class="col-3">
                        <span class="form-control-plaintext subtotal-display">$0.00</span>
                    </div>
                    <div class="col-1">
                        <button type="button" class="btn btn-danger btn-sm" onclick="eliminarIngrediente(this)">√ó</button>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-success btn-sm" onclick="agregarIngrediente()">+ Agregar Ingrediente</button>
        </div>

        <div class="mb-3">
            <label class="form-label">Mano de Obra (%)</label>
            <input type="number" id="manoObra" name="manoObraPorcentaje" class="form-control" value="20" step="1" min="0" max="100" />
            <div class="form-text">Porcentaje sobre el costo de ingredientes</div>
        </div>

        <div class="mb-3">
            <label class="form-label">Disponible</label>
            <select asp-for="Disponible" class="form-select">
                <option value="true">S√≠</option>
                <option value="false">No</option>
            </select>
        </div>

        <div class="mb-3">
            <label class="form-label">Imagen actual</label>
            @if (!string.IsNullOrEmpty(Model.ImagenUrl))
            {
                <div class="mb-2">
                    <img id="imagenActual" src="@Model.ImagenUrl" alt="@Model.Nombre" style="width:140px; height:140px; object-fit:cover; border-radius:8px; border:1px solid #ddd;" />
                </div>
            }
            else
            {
                <p class="text-muted fst-italic">No hay imagen cargada</p>
            }
        </div>

        <div class="mb-3">
            <label class="form-label">Cambiar Imagen (opcional)</label>
            <input type="file" name="imagen" class="form-control" accept="image/*" id="inputImagen" />
        </div>

        <div class="mb-3 text-center">
            <img id="previewImagen" src="#" alt="Vista previa" class="img-fluid rounded shadow-sm d-none" style="max-height: 250px; object-fit: cover;" />
        </div>

        <div class="mt-3">
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-save"></i> Guardar Cambios
            </button>
            <a asp-action="Index" class="btn btn-secondary ms-2">Cancelar</a>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        console.log("üî• INICIO REAL DEL SCRIPT EDIT");

        console.log("DEBUG: Script cargado en Edit.cshtml ‚úî");

        document.addEventListener("DOMContentLoaded", () => {
            console.log("DEBUG: DOMContentLoaded ‚úî");
        });

        const form = document.querySelector("form");
        console.log("DEBUG: Form detectado:", form);

        if (!form) {
            console.error("ERROR: No encontr√© el formulario. El script se ejecut√≥ muy temprano o la vista no tiene <form>.");
        }

        window.onerror = (...args) => {
            console.error("üí• ERROR GLOBAL DETECTADO:", args);
        };

        const input = document.getElementById('inputImagen');
        const preview = document.getElementById('previewImagen');

        input.addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    preview.src = event.target.result;
                    preview.classList.remove('d-none');
                };
                reader.readAsDataURL(file);
            } else {
                preview.src = '#';
                preview.classList.add('d-none');
            }
        });

        let todosLosIngredientes = [];

        fetch('/api/ingredientes')
            .then(response => response.json())
            .then(data => {
                todosLosIngredientes = data;
                cargarIngredientesEnSelects();
            })
            .catch(() => {
                todosLosIngredientes = [];
            });

        function cargarIngredientesEnSelects() {
            document.querySelectorAll('.ingrediente-select').forEach(select => {
                select.innerHTML = '<option value="">Seleccione ingrediente</option>';
                todosLosIngredientes.forEach(ing => {
                    const option = document.createElement('option');
                    option.value = ing.id;
                    option.dataset.costo = ing.costoUnitario;
                    option.dataset.unidad = ing.unidadMedida?.abreviatura || '';
                    option.textContent = `${ing.nombre} ($${ing.costoUnitario}/${ing.unidadMedida?.abreviatura || 'u'})`;
                    select.appendChild(option);
                });
            });
        }

        function agregarIngrediente() {
            const container = document.getElementById('ingredientesPlato');
            const newRow = document.createElement('div');
            newRow.className = 'row mb-2';
            newRow.innerHTML = `
                <div class="col-5">
                    <select class="form-select ingrediente-select" onchange="calcularSubtotal(this)">
                        <option value="">Seleccione ingrediente</option>
                    </select>
                </div>
                <div class="col-3">
                    <input type="number" class="form-control cantidad-input" placeholder="Cantidad" step="0.01" min="0.01" oninput="calcularSubtotal(this)" />
                </div>
                <div class="col-3">
                    <span class="form-control-plaintext subtotal-display">$0.00</span>
                </div>
                <div class="col-1">
                    <button type="button" class="btn btn-danger btn-sm" onclick="eliminarIngrediente(this)">√ó</button>
                </div>
            `;
            container.appendChild(newRow);
            cargarIngredientesEnSelects();
        }

        function eliminarIngrediente(btn) {
            btn.closest('.row').remove();
            calcularCostoTotal();
        }

        function calcularSubtotal(element) {
            const row = element.closest('.row');
            const select = row.querySelector('.ingrediente-select');
            const cantidadInput = row.querySelector('.cantidad-input');
            const subtotalDisplay = row.querySelector('.subtotal-display');

            const selectedOption = select.selectedOptions[0];
            const cantidad = parseFloat(cantidadInput.value) || 0;

            if (selectedOption && selectedOption.value && selectedOption.dataset.costo && cantidad > 0) {
                const costo = parseFloat(selectedOption.dataset.costo);
                const subtotal = cantidad * costo;
                subtotalDisplay.textContent = `$${subtotal.toFixed(2)}`;
            } else {
                subtotalDisplay.textContent = '$0.00';
            }

            calcularCostoTotal();
        }

        function calcularCostoTotal() {
            const manualInput = document.getElementById('costoTotalManual');
            const manualValue = parseFloat((manualInput?.value || '').toString().replace(',', '.'));
            if (!Number.isNaN(manualValue) && manualValue > 0) {
                document.querySelector('input[name="CostoTotal"]').value = manualValue.toFixed(2);
                return;
            }

            let totalIngredientes = 0;
            document.querySelectorAll('.subtotal-display').forEach(display => {
                const subtotal = parseFloat(display.textContent.replace('$', '')) || 0;
                totalIngredientes += subtotal;
            });

            const manoObraPorcentaje = parseFloat(document.getElementById('manoObra').value) || 0;
            const manoObraValor = totalIngredientes * (manoObraPorcentaje / 100);
            const costoTotal = totalIngredientes + manoObraValor;

            document.querySelector('input[name="CostoTotal"]').value = costoTotal.toFixed(2);
        }

        document.getElementById('manoObra').addEventListener('input', calcularCostoTotal);
        document.getElementById('costoTotalManual').addEventListener('input', calcularCostoTotal);

        document.querySelector('form').addEventListener('submit', function (e) {
            console.log('Formulario enviado');
            calcularCostoTotal();
            const ingredientes = [];

            document.querySelectorAll('#ingredientesPlato .row').forEach(row => {
                const select = row.querySelector('.ingrediente-select');
                const cantidadInput = row.querySelector('.cantidad-input');
                const subtotalDisplay = row.querySelector('.subtotal-display');

                if (select.value && cantidadInput.value) {
                    ingredientes.push({
                        ingredienteId: parseInt(select.value),
                        cantidad: parseFloat(cantidadInput.value),
                        subtotal: parseFloat(subtotalDisplay.textContent.replace('$', ''))
                    });
                }
            });

            console.log('Ingredientes a enviar:', ingredientes);
            document.getElementById('ingredientesData').value = JSON.stringify(ingredientes);
        });

        document.addEventListener("DOMContentLoaded", function () {
            const ingredientesDesdeServidor = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                ViewData["IngredientesPlato"] ?? new List<object>()
            ));

            console.log("Ingredientes cargados para edici√≥n:", ingredientesDesdeServidor);

            const container = document.getElementById("ingredientesPlato");
            container.innerHTML = "";

            ingredientesDesdeServidor.forEach(item => {
                const newRow = document.createElement("div");
                newRow.className = "row mb-2";

                newRow.innerHTML = `
                    <div class="col-5">
                        <select class="form-select ingrediente-select" onchange="calcularSubtotal(this)">
                            <option value="">Seleccione ingrediente</option>
                        </select>
                    </div>
                    <div class="col-3">
                        <input type="number" class="form-control cantidad-input" value="${item.Cantidad}" step="0.01" min="0.01" oninput="calcularSubtotal(this)" />
                    </div>
                    <div class="col-3">
                        <span class="form-control-plaintext subtotal-display">$${item.Subtotal.toFixed(2)}</span>
                    </div>
                    <div class="col-1">
                        <button type="button" class="btn btn-danger btn-sm" onclick="eliminarIngrediente(this)">√ó</button>
                    </div>
                `;

                container.appendChild(newRow);
            });

            setTimeout(() => {
                cargarIngredientesEnSelects();
                document.querySelectorAll(".ingrediente-select").forEach((select, index) => {
                    const idCorrecto = ingredientesDesdeServidor[index]?.IngredienteId;
                    if (idCorrecto) {
                        select.value = idCorrecto;
                    }
                });
                calcularCostoTotal();
            }, 200);
        });
    </script>
}
