@model MiRoti.Models.Plato 
@{
    ViewData["Title"] = "Nuevo Plato";
}

<div class="container mt-4">
    <h2 class="fw-bold mb-4">Agregar Nuevo Plato</h2>

    <form asp-action="CreateSimple" method="post" enctype="multipart/form-data">
        @Html.AntiForgeryToken()
        <div class="mb-3">
            <label class="form-label">Nombre</label>
            <input asp-for="Nombre" class="form-control" />
        </div>

        <div class="mb-3">
            <label class="form-label">Descripción</label>
            <textarea asp-for="Descripcion" class="form-control"></textarea>
        </div>

        <div class="mb-3">
            <label class="form-label">Precio Venta</label>
            <input asp-for="PrecioVenta" class="form-control" type="number" step="0.01" />
        </div>

        <div class="mb-3">
            <label class="form-label">Ingredientes del Plato</label>
            <div id="ingredientesPlato">
                <div class="row mb-2">
                    <div class="col-5">
                        <select class="form-select ingrediente-select" onchange="calcularSubtotal(this)">
                            <option value="">Seleccione ingrediente</option>
                        </select>
                    </div>
                    <div class="col-3">
                        <input type="number" class="form-control cantidad-input" placeholder="Cantidad" step="0.01" min="0.01" oninput="calcularSubtotal(this)" />
                    </div>
                    <div class="col-3">
                        <span class="form-control-plaintext subtotal-display">$0.00</span>
                    </div>
                    <div class="col-1">
                        <button type="button" class="btn btn-danger btn-sm" onclick="eliminarIngrediente(this)">×</button>
                    </div>
                </div>
            </div>
            <button type="button" class="btn btn-success btn-sm" onclick="agregarIngrediente()">+ Agregar Ingrediente</button>
        </div>

        <div class="mb-3">
            <label class="form-label">Mano de Obra (%)</label>
            <input type="number" id="manoObra" name="manoObraPorcentaje" class="form-control" value="20" step="1" min="0" max="100" />
        </div>

        <div class="mb-3">
            <label class="form-label">Costo Total (Calculado)</label>
            <input asp-for="CostoTotal" class="form-control" type="number" step="0.01" readonly style="background-color: #f8f9fa;" />
        </div>

        <div class="mb-3">
            <label class="form-label">Costo Total (Manual - opcional)</label>
            <input type="number" id="costoTotalManual" name="costoTotalManual" class="form-control" step="0.01" min="0" placeholder="Dejar vacío para calcular automáticamente" />
            <div class="form-text">Si completás este campo, se usará este valor y no se recalculará el costo total.</div>
        </div>

        <div class="mb-3">
            <label class="form-label">Imagen del Plato (opcional)</label>
            <input type="file" name="imagen" class="form-control" accept="image/*" />
        </div>

        <input type="hidden" id="ingredientesData" name="ingredientesData" />

        <button type="submit" id="btnGuardarPlatoSimple" class="btn btn-warning text-white">
            <i class="bi bi-save"></i> Guardar Plato
        </button>
        <a asp-action="Index" class="btn btn-secondary ms-2">Cancelar</a>
    </form>
</div>

@section Scripts {
    <script>
    window.addEventListener('DOMContentLoaded', function() {
        console.log('Script iniciado');
        
        let todosLosIngredientes = [];
        
        // Cargar ingredientes
        fetch('/api/ingredientes')
            .then(r => r.json())
            .then(ingredientes => {
                console.log('Ingredientes:', ingredientes);
                todosLosIngredientes = ingredientes;
                cargarIngredientesEnSelects();
            })
            .catch(error => console.error('Error:', error));
        
        function cargarIngredientesEnSelects() {
            document.querySelectorAll('.ingrediente-select').forEach(select => {
                llenarSelect(select);
            });
        }

        function llenarSelect(select) {
            select.innerHTML = '<option value="">Seleccione ingrediente</option>';
            todosLosIngredientes.forEach(ing => {
                const option = document.createElement('option');
                option.value = ing.id;
                option.setAttribute('data-costo', ing.costoUnitario);
                option.textContent = ing.nombre + ' ($' + ing.costoUnitario + ')';
                select.appendChild(option);
            });
        }
        
        window.calcularSubtotal = function(element) {
            console.log('Calculando subtotal...');
            const row = element.closest('.row');
            const select = row.querySelector('.ingrediente-select');
            const cantidadInput = row.querySelector('.cantidad-input');
            const subtotalDisplay = row.querySelector('.subtotal-display');
            
            const selectedOption = select.selectedOptions[0];
            const cantidad = parseFloat(cantidadInput.value) || 0;
            
            if (selectedOption && selectedOption.value && cantidad > 0) {
                const costo = parseFloat(selectedOption.getAttribute('data-costo')) || 0;
                const subtotal = cantidad * costo;
                subtotalDisplay.textContent = '$' + subtotal.toFixed(2);
                console.log('Subtotal calculado:', subtotal);
                calcularCostoTotal();
            } else {
                subtotalDisplay.textContent = '$0.00';
            }
        };
        
        function calcularCostoTotal() {
            const manualInput = document.getElementById('costoTotalManual');
            const manualValue = parseFloat((manualInput?.value || '').toString().replace(',', '.'));
            if (!Number.isNaN(manualValue) && manualValue > 0) {
                document.querySelector('input[name="CostoTotal"]').value = manualValue.toFixed(2);
                return;
            }

            let totalIngredientes = 0;
            document.querySelectorAll('.subtotal-display').forEach(display => {
                const subtotal = parseFloat(display.textContent.replace('$', '')) || 0;
                totalIngredientes += subtotal;
            });
            
            const manoObraPorcentaje = parseFloat(document.getElementById('manoObra').value) || 0;
            const manoObraValor = totalIngredientes * (manoObraPorcentaje / 100);
            const costoTotal = totalIngredientes + manoObraValor;
            
            document.querySelector('input[name="CostoTotal"]').value = costoTotal.toFixed(2);
            console.log('Costo total:', costoTotal);
        }
        
        window.eliminarIngrediente = function(btn) {
            btn.closest('.row').remove();
            calcularCostoTotal();
        };
        
        document.getElementById('manoObra').addEventListener('input', calcularCostoTotal);
        document.getElementById('costoTotalManual').addEventListener('input', calcularCostoTotal);

        window.agregarIngrediente = function() {
            const container = document.getElementById('ingredientesPlato');
            const newRow = document.createElement('div');
            newRow.className = 'row mb-2';
            newRow.innerHTML = `
                <div class="col-5">
                    <select class="form-select ingrediente-select" onchange="calcularSubtotal(this)">
                        <option value="">Seleccione ingrediente</option>
                    </select>
                </div>
                <div class="col-3">
                    <input type="number" class="form-control cantidad-input" placeholder="Cantidad" step="0.01" min="0.01" oninput="calcularSubtotal(this)" />
                </div>
                <div class="col-3">
                    <span class="form-control-plaintext subtotal-display">$0.00</span>
                </div>
                <div class="col-1">
                    <button type="button" class="btn btn-danger btn-sm" onclick="eliminarIngrediente(this)">×</button>
                </div>
            `;
            container.appendChild(newRow);
            const newSelect = newRow.querySelector('.ingrediente-select');
            if (newSelect) {
                llenarSelect(newSelect);
            }
        };

        const form = document.querySelector("form");
        const botonGuardar = document.getElementById("btnGuardarPlatoSimple");

        form.addEventListener("submit", function (e) {
            if (this.dataset.submitting === "true") {
                e.preventDefault();
                return;
            }

            this.dataset.submitting = "true";
            if (botonGuardar) {
                botonGuardar.disabled = true;
            }

            calcularCostoTotal();
            const ingredientes = [];

            document.querySelectorAll("#ingredientesPlato .row").forEach(row => {
                const select = row.querySelector(".ingrediente-select");
                const cantidadInput = row.querySelector(".cantidad-input");
                const subtotalDisplay = row.querySelector(".subtotal-display");

                const ingredienteId = parseInt(select.value);
                const cantidad = parseFloat(cantidadInput.value);
                const subtotal = parseFloat(subtotalDisplay.textContent.replace("$", "")) || 0;

                if (!isNaN(ingredienteId) && ingredienteId > 0 && !isNaN(cantidad) && cantidad > 0) {
                    ingredientes.push({
                        IngredienteId: ingredienteId,
                        Cantidad: cantidad,
                        Subtotal: subtotal
                    });
                }
            });

            document.getElementById("ingredientesData").value = JSON.stringify(ingredientes);
        });
    });
    </script>
}
